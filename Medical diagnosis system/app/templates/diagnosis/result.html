{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="fw-bold">Step 2: Diagnosis Analysis</h2>
            <a href="{{ url_for('diagnosis.download_report', diagnosis_id=diagnosis.id) }}"
                class="btn btn-medical bg-transparent border-info text-info">
                <i class="fas fa-file-pdf me-2"></i> Download Full Report
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Risk Assessment Card -->
    <div class="col-lg-4">
        <div class="card h-100 border-{{ risk_level['color'] }}">
            <div class="card-header text-{{ risk_level['color'] }}">
                <i class="fas fa-exclamation-triangle me-2"></i> Risk Classification: {{ risk_level['label'] }}
            </div>
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <h1 class="display-1 fw-bold text-{{ risk_level['color'] }}">{{ diagnosis.risk_score }}%</h1>
                <p class="h5">Risk Score</p>
                <div class="risk-bar-container mt-3">
                    <div class="risk-bar bg-{{ risk_level['color'] }}" style="width: {{ diagnosis.risk_score }}%"></div>
                </div>
                <p class="text-dim mt-4 small">{{ risk_level['description'] }}</p>

                {% if diagnosis.risk_score > 50 %}
                <div class="alert alert-danger pulse-red mt-3 py-2 small">
                    <i class="fas fa-phone-alt me-2"></i> Emergency Alert: High risk detected!
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Prediction Results -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header"><i class="fas fa-list-ol me-2"></i> Top AI Predictions</div>
            <div class="card-body">
                {% for pred in top_diseases %}
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="fw-bold">{{ pred['disease'] }}</span>
                        <span>{{ pred['probability'] }}% Confidence</span>
                    </div>
                    <div class="progress" style="height: 12px; background-color: #1a2332;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ pred['probability'] }}%">
                        </div>
                    </div>
                </div>
                {% endfor %}

                <div class="mt-4 p-3 bg-dark rounded border border-info">
                    <h6 class="text-info"><i class="fas fa-vial me-2"></i> Similarity Clustering</h6>
                    <p class="small text-dim mb-2">Based on your primary diagnosis ({{ similar_info['target_disease']
                        }}), here are related conditions often seen in clinical clusters:</p>
                    <div class="d-flex flex-wrap gap-2">
                        {% for disease in similar_info['similar_diseases'] %}
                        <span class="badge bg-secondary opacity-75">{{ disease }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-success bg-opacity-10 border-success">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="text-success mb-1">Recommended Next Step: Doctor Consultation</h4>
                    <p class="mb-0 text-dim">Would you like to book an appointment with a specialist related to your top
                        prediction?</p>
                </div>
                <a href="{{ url_for('appointments.book') }}" class="btn btn-success px-4 py-2">
                    <i class="fas fa-calendar-check me-2"></i> Book Appointment
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

